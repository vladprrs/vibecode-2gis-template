<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2GIS MapGL Integration Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #f5f5f5;
            overflow: hidden;
        }

        #mapgl-demo {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        .loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 10000;
            transition: opacity 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .loading-details {
            font-size: 14px;
            opacity: 0.8;
            text-align: center;
            max-width: 300px;
        }

        .test-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .test-button {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .test-button:hover {
            background: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .test-button.active {
            background: #1976D2;
            color: white;
        }

        .status-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 1001;
            max-height: 200px;
            overflow-y: auto;
        }

        .status-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .status-log {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            color: #666;
            max-height: 120px;
            overflow-y: auto;
        }

        .status-log .success {
            color: #4CAF50;
        }

        .status-log .error {
            color: #F44336;
        }

        .status-log .info {
            color: #2196F3;
        }

        .error-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(244, 67, 54, 0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 10001;
            text-align: center;
            padding: 20px;
        }

        .error-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .error-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .error-message {
            font-size: 16px;
            opacity: 0.9;
            margin-bottom: 20px;
            max-width: 400px;
        }

        .retry-button {
            padding: 10px 20px;
            border: 2px solid white;
            border-radius: 6px;
            background: transparent;
            color: white;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .retry-button:hover {
            background: white;
            color: #F44336;
        }
    </style>
</head>
<body>
    <!-- –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ 2GIS MapGL</div>
        <div class="loading-details">
            –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤...<br>
            API Key: bfa6ee5b-5e88-44f0-b4ad-394e819f26fc
        </div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω –æ—à–∏–±–∫–∏ -->
    <div id="error-screen" class="error-screen">
        <div class="error-icon">‚ùå</div>
        <div class="error-title">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>
        <div id="error-message" class="error-message">
            –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å 2GIS MapGL API
        </div>
        <button class="retry-button" onclick="retryLoad()">
            –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
        </button>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –¥–µ–º–æ -->
    <div id="mapgl-demo"></div>

    <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–µ—Å—Ç–∞–º–∏ -->
    <div class="test-controls">
        <button class="test-button" onclick="switchToScreen('dashboard')">
            üè† Dashboard
        </button>
        <button class="test-button" onclick="switchToScreen('suggest')">
            üîç Suggest
        </button>
        <button class="test-button" onclick="switchToScreen('search_result')">
            üìã Results
        </button>
        <button class="test-button" onclick="switchToScreen('organization')">
            üè¢ Organization
        </button>
        <button class="test-button" onclick="testGeolocation()">
            üìç –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è
        </button>
        <button class="test-button" onclick="testMarkers()">
            üìå –¢–µ—Å—Ç –º–∞—Ä–∫–µ—Ä–æ–≤
        </button>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å —Å—Ç–∞—Ç—É—Å–∞ -->
    <div class="status-panel">
        <div class="status-title">üìä –°—Ç–∞—Ç—É—Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏</div>
        <div id="status-log" class="status-log">
            –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...
        </div>
    </div>

    <!-- 2GIS MapGL API -->
    <script src="https://mapgl.2gis.com/api/js/v2?key=bfa6ee5b-5e88-44f0-b4ad-394e819f26fc"></script>
    
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let demoInstance = null;
        let currentScreen = 'dashboard';
        let mapComponent = null;
        let mapSyncService = null;

        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('status-log');
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(`[MapGL Test] ${message}`);
        }

        // –ü–æ–∫–∞–∑ –æ—à–∏–±–∫–∏
        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-screen').style.display = 'flex';
            document.getElementById('loading-screen').classList.add('hidden');
        }

        // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
        function retryLoad() {
            document.getElementById('error-screen').style.display = 'none';
            document.getElementById('loading-screen').classList.remove('hidden');
            setTimeout(initializeDemo, 1000);
        }

        // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –Ω–∞—à–∏—Ö –∫–ª–∞—Å—Å–æ–≤ –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞
        class SimpleBrowserDemo {
            constructor(container) {
                this.container = container;
                this.mapContainer = null;
                this.map = null;
                this.markers = new Map();
                this.currentPins = [];
                
                this.initialize();
            }

            async initialize() {
                try {
                    log('–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤...', 'info');
                    this.setupContainers();
                    
                    log('–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ MapGL API...', 'info');
                    await this.waitForMapGL();
                    
                    log('–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã...', 'info');
                    await this.createMap();
                    
                    log('–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤...', 'info');
                    this.addTestMarkers();
                    
                    log('‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!', 'success');
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏
                    document.getElementById('loading-screen').classList.add('hidden');
                    
                } catch (error) {
                    log(`‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${error.message}`, 'error');
                    showError(error.message);
                }
            }

            setupContainers() {
                this.mapContainer = document.createElement('div');
                this.mapContainer.style.cssText = `
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    z-index: 1;
                `;
                this.container.appendChild(this.mapContainer);
            }

            async waitForMapGL() {
                return new Promise((resolve, reject) => {
                    let attempts = 0;
                    const maxAttempts = 50;
                    
                    const checkMapGL = () => {
                        attempts++;
                        
                        if (window.mapgl) {
                            resolve(window.mapgl);
                        } else if (attempts >= maxAttempts) {
                            reject(new Error('MapGL API –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è –∑–∞ –æ—Ç–≤–µ–¥–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è'));
                        } else {
                            setTimeout(checkMapGL, 200);
                        }
                    };
                    
                    checkMapGL();
                });
            }

            async createMap() {
                if (!window.mapgl) {
                    throw new Error('MapGL API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                }

                this.map = new mapgl.Map(this.mapContainer, {
                    center: [37.620393, 55.75396], // –ú–æ—Å–∫–≤–∞
                    zoom: 10,
                    key: 'bfa6ee5b-5e88-44f0-b4ad-394e819f26fc'
                });

                // –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫–∞—Ä—Ç—ã
                await new Promise((resolve) => {
                    this.map.on('styleload', resolve);
                });

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                this.map.on('click', (event) => {
                    log(`–ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ: ${event.lngLat.lng.toFixed(6)}, ${event.lngLat.lat.toFixed(6)}`, 'info');
                });

                log('–ö–∞—Ä—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é', 'success');
            }

            addTestMarkers() {
                const testPins = [
                    {
                        id: 'kremlin',
                        coordinates: [37.617734, 55.752023],
                        title: '–ú–æ—Å–∫–æ–≤—Å–∫–∏–π –ö—Ä–µ–º–ª—å',
                        type: 'organization'
                    },
                    {
                        id: 'red_square',
                        coordinates: [37.622504, 55.753215],
                        title: '–ö—Ä–∞—Å–Ω–∞—è –ø–ª–æ—â–∞–¥—å',
                        type: 'search_result'
                    },
                    {
                        id: 'gum',
                        coordinates: [37.618423, 55.751244],
                        title: '–ì–£–ú',
                        type: 'organization'
                    }
                ];

                testPins.forEach(pin => this.addMarker(pin));
                log(`–î–æ–±–∞–≤–ª–µ–Ω–æ ${testPins.length} —Ç–µ—Å—Ç–æ–≤—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤`, 'success');
            }

            addMarker(pin) {
                const marker = new mapgl.Marker({
                    lngLat: pin.coordinates,
                    color: this.getMarkerColor(pin.type)
                });

                marker.on('click', () => {
                    log(`–ö–ª–∏–∫ –ø–æ –º–∞—Ä–∫–µ—Ä—É: ${pin.title}`, 'info');
                    this.highlightMarker(pin.id);
                });

                marker.addTo(this.map);
                this.markers.set(pin.id, marker);
                this.currentPins.push(pin);
            }

            getMarkerColor(type) {
                const colors = {
                    organization: '#1976D2',
                    search_result: '#FF5722',
                    user_location: '#4CAF50',
                    selected: '#9C27B0'
                };
                return colors[type] || '#666666';
            }

            highlightMarker(pinId) {
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –º–∞—Ä–∫–µ—Ä—ã
                this.markers.forEach((marker, id) => {
                    const pin = this.currentPins.find(p => p.id === id);
                    if (pin) {
                        marker.setOptions({ color: this.getMarkerColor(pin.type) });
                    }
                });

                // –í—ã–¥–µ–ª—è–µ–º –Ω—É–∂–Ω—ã–π –º–∞—Ä–∫–µ—Ä
                const marker = this.markers.get(pinId);
                if (marker) {
                    marker.setOptions({ color: '#FF5722' });
                    log(`–ú–∞—Ä–∫–µ—Ä ${pinId} –≤—ã–¥–µ–ª–µ–Ω`, 'success');
                }
            }

            setCenter(coordinates, zoom = null) {
                if (this.map) {
                    this.map.setCenter(coordinates);
                    if (zoom) {
                        this.map.setZoom(zoom);
                    }
                    log(`–ö–∞—Ä—Ç–∞ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ ${coordinates.join(', ')}`, 'info');
                }
            }

            testGeolocation() {
                if (navigator.geolocation) {
                    log('–ó–∞–ø—Ä–æ—Å –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏...', 'info');
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const coords = [position.coords.longitude, position.coords.latitude];
                            
                            // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                            this.addMarker({
                                id: 'user_location',
                                coordinates: coords,
                                title: '–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ',
                                type: 'user_location'
                            });
                            
                            // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É
                            this.setCenter(coords, 15);
                            
                            log(`‚úÖ –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∞: ${coords.join(', ')}`, 'success');
                        },
                        (error) => {
                            log(`‚ùå –û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏: ${error.message}`, 'error');
                        }
                    );
                } else {
                    log('‚ùå –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º', 'error');
                }
            }

            simulateScreen(screenType) {
                log(`–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ —ç–∫—Ä–∞–Ω: ${screenType}`, 'info');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
                document.querySelectorAll('.test-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                const activeButton = document.querySelector(`[onclick*="${screenType}"]`);
                if (activeButton) {
                    activeButton.classList.add('active');
                }

                // –ò–º–∏—Ç–∏—Ä—É–µ–º –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Ä–∞–∑–Ω—ã—Ö —ç–∫—Ä–∞–Ω–æ–≤
                switch (screenType) {
                    case 'dashboard':
                        this.setCenter([37.620393, 55.75396], 12);
                        log('üì± Dashboard: –ø–æ–∫–∞–∑–∞–Ω—ã –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –º–µ—Å—Ç–∞', 'info');
                        break;
                        
                    case 'suggest':
                        this.setCenter([37.620393, 55.75396], 11);
                        log('üîç Suggest: —Ä–µ–∂–∏–º –ø–æ–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω', 'info');
                        break;
                        
                    case 'search_result':
                        this.setCenter([37.620393, 55.75396], 13);
                        this.highlightMarker('red_square');
                        log('üìã Search Results: –ø–æ–∫–∞–∑–∞–Ω—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞', 'info');
                        break;
                        
                    case 'organization':
                        this.setCenter([37.617734, 55.752023], 16);
                        this.highlightMarker('kremlin');
                        log('üè¢ Organization: –ø–æ–∫–∞–∑–∞–Ω–∞ –¥–µ—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞', 'info');
                        break;
                }
                
                currentScreen = screenType;
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        function switchToScreen(screenType) {
            if (demoInstance) {
                demoInstance.simulateScreen(screenType);
            }
        }

        function testGeolocation() {
            if (demoInstance) {
                demoInstance.testGeolocation();
            }
        }

        function testMarkers() {
            if (demoInstance) {
                log('üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤...', 'info');
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã
                const randomMarkers = [];
                for (let i = 0; i < 5; i++) {
                    const coords = [
                        37.620393 + (Math.random() - 0.5) * 0.02,
                        55.75396 + (Math.random() - 0.5) * 0.02
                    ];
                    
                    const marker = {
                        id: `test_${i}`,
                        coordinates: coords,
                        title: `–¢–µ—Å—Ç–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä ${i + 1}`,
                        type: 'search_result'
                    };
                    
                    demoInstance.addMarker(marker);
                    randomMarkers.push(marker);
                }
                
                log(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ ${randomMarkers.length} —Ç–µ—Å—Ç–æ–≤—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤`, 'success');
                
                // –ß–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –≤—ã–¥–µ–ª—è–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –º–∞—Ä–∫–µ—Ä
                setTimeout(() => {
                    const randomMarker = randomMarkers[Math.floor(Math.random() * randomMarkers.length)];
                    demoInstance.highlightMarker(randomMarker.id);
                    demoInstance.setCenter(randomMarker.coordinates, 15);
                }, 2000);
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        async function initializeDemo() {
            try {
                log('üöÄ –ó–∞–ø—É—Å–∫ MapGL Integration Test...', 'info');
                
                const container = document.getElementById('mapgl-demo');
                demoInstance = new SimpleBrowserDemo(container);
                
            } catch (error) {
                log(`‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${error.message}`, 'error');
                showError(error.message);
            }
        }

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ DOM
        document.addEventListener('DOMContentLoaded', () => {
            log('üìÑ DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –∑–∞–ø—É—Å–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏...', 'info');
            
            // –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É MapGL API
            setTimeout(initializeDemo, 2000);
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
        window.addEventListener('error', (event) => {
            log(`‚ùå JavaScript –æ—à–∏–±–∫–∞: ${event.message}`, 'error');
        });

        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
        setInterval(() => {
            if (demoInstance && demoInstance.map) {
                const center = demoInstance.map.getCenter();
                const zoom = demoInstance.map.getZoom();
                document.title = `MapGL Test - ${currentScreen} (${center.lng.toFixed(4)}, ${center.lat.toFixed(4)}) Z${zoom.toFixed(1)}`;
            }
        }, 1000);
    </script>
</body>
</html> 